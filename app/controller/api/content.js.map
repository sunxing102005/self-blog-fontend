{
    "version": 3,
    "sources": [
        "../../../src/controller/api/content.js"
    ],
    "names": [
        "BaseRest",
        "require",
        "module",
        "exports",
        "getAction",
        "data",
        "params",
        "id",
        "modelInstance",
        "where",
        "find",
        "userInfo",
        "increament",
        "success",
        "type",
        "get",
        "status",
        "category_id",
        "order",
        "fieldReverse",
        "select",
        "limit",
        "field",
        "sum",
        "count",
        "model",
        "recent",
        "content",
        "think",
        "cache",
        "comment",
        "all",
        "key",
        "self",
        "contentType",
        "page",
        "pageSize",
        "countSelect",
        "putAction",
        "fail",
        "postAction",
        "createTime",
        "post",
        "publishTime",
        "user_id",
        "title",
        "slug",
        "markdown",
        "tag",
        "thumb",
        "publish_time",
        "view",
        "like",
        "recommend",
        "modify_time",
        "Object",
        "keys",
        "forEach",
        "val",
        "res",
        "save",
        "hook",
        "insert",
        "deleteAction",
        "oldContent",
        "item",
        "decrement",
        "affectedRows",
        "delete"
    ],
    "mappings": "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",
    "file": "../../../src/controller/api/content.js",
    "sourcesContent": [
        "const BaseRest = require(\"../rest.js\");\n\nmodule.exports = class extends BaseRest {\n    async getAction() {\n        let data;\n        const params = {};\n        if (this.id) {\n            params[\"id\"] = this.id;\n            data = await this.modelInstance.where(params).find();\n            if (!this.userInfo) {\n                this.modelInstance.where(params).increament(\"view\");\n            }\n            return this.success(data);\n        }\n        const type = this.get(\"type\") || \"default\";\n        // 归档\n        if (type === \"archives\") {\n            data = await this.modelInstance\n                .where({ status: 99, category_id: [\"IN\", [1, 2]] })\n                .order(\"create_time desc\")\n                .fieldReverse(\"content,markdown\")\n                .select();\n            return this.success(data);\n        }\n        // 热门文章\n        if (type === \"hot\") {\n            data = await this.modelInstance\n                .where({ status: 99 })\n                .order(\"view desc\")\n                .limit(10)\n                .field(\"title,slug,view\")\n                .select();\n            return this.success(data);\n        }\n        // 总览数据\n        if (type === \"summary\") {\n            data = {};\n            data[\"view\"] = await this.modelInstance\n                .where({ status: 99 })\n                .sum(\"view\");\n            data[\"count\"] = await this.modelInstance\n                .where({ status: 99 })\n                .count();\n            data[\"comments\"] = await this.model(\"comment\")\n                .where({ status: 99 })\n                .count();\n            return this.success(data);\n        }\n        if (type === \"recent\") {\n            const recent = {\n                content: think.cache(\"recent_content\"),\n                comment: think.cache(\"recent_comment\")\n            };\n            return { recent };\n        }\n        // 是否获取全部\n        const all = this.get(\"all\");\n        // if (!all || think.isEmpty(this.userInfo)) {\n        if (!all) {\n            params.status = 99;\n        }\n        // 关键词\n        const key = this.get(\"key\");\n        if (key) {\n            params[\"title|description\"] = [\"like\", `%${key}%`];\n        }\n        const status = this.get(\"status\");\n        if (status) {\n            params.status = status;\n        }\n        const self = this.get(\"self\"); //是否个人自我介绍\n        if (self == \"y\") {\n            params.category_id = [\"IN\", [33]]; //category是self的，id是33，这里先写死\n        }\n        // 内容类型\n        const contentType = this.get(\"contentType\") || \"post\";\n        params[\"type\"] = contentType;\n        // 页码\n        const page = this.get(\"page\") || 1;\n        // 每页显示数量\n        const pageSize = this.get(\"pageSize\") || 5;\n        data = await this.modelInstance\n            .where(params)\n            .page(page, pageSize)\n            .order(\"create_time desc\")\n            .fieldReverse(\"content,markdown\")\n            .countSelect();\n        return this.success(data);\n    }\n    async putAction() {\n        if (!this.id) {\n            return this.fail(1001, \"文章不存在\");\n        }\n    }\n    async postAction() {\n        const userInfo = this.userInfo;\n        const createTime = this.post(\"date\");\n        let publishTime = null;\n        if (this.post(\"status\") != 1) {\n            publishTime = createTime;\n        }\n        const data = {\n            user_id: userInfo.id,\n            title: this.post(\"title\"),\n            category_id: this.post(\"category_id\"),\n            slug: this.post(\"slug\"),\n            status: this.post(\"status\"),\n            markdown: this.post(\"markdown\"),\n            content: this.post(\"content\"),\n            tag: this.post(\"tag\"),\n            type: this.post(\"type\"),\n            thumb: this.post(\"thumb\") || \"\",\n            publish_time: publishTime,\n            view: 0,\n            like: 0,\n            recommend: this.post(\"recommend\"),\n            // create_time: createTime,\n            modify_time: createTime\n        };\n        if (this.id) {\n            data.id = this.post(\"id\");\n            Object.keys(data).forEach(val => {\n                if (!data[val]) {\n                    delete data[val];\n                }\n            });\n            const res = await this.modelInstance.save(data);\n            await this.hook(\"contentUpdate\", data);\n            if (res) {\n                this.success({ id: this.id }, \"修改成功!\");\n            } else {\n                return this.fail(1000, \"修改失败\");\n            }\n        } else {\n            data[\"create_time\"] = createTime;\n            const id = await this.modelInstance.insert(data);\n            if (id) {\n                data.id = id;\n                this.hook(\"contentCreate\", data);\n                this.success({ id }, \"添加成功!\");\n            } else {\n                return this.fail(1000, \"添加失败\");\n            }\n        }\n    }\n    async deleteAction() {\n        if (!this.id) {\n            return this.fail(1001, \"文章不存在\");\n        }\n        const oldContent = await this.modelInstance\n            .where({ id: this.id })\n            .find();\n        // oldContent.tag.forEach(val => {});\n        for (const item of oldContent.tag) {\n            await think\n                .model(\"meta\")\n                .where({ id: item.id })\n                .decrement(\"count\");\n        }\n        const affectedRows = await this.modelInstance\n            .where({ id: this.id })\n            .delete();\n        if (affectedRows) {\n            this.hook(\"contentDelete\", { id: this.id });\n            return this.success(affectedRows);\n        } else {\n            this.fail(1000, \"删除失败\");\n        }\n    }\n};\n"
    ]
}
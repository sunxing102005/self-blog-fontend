{
    "version": 3,
    "sources": [
        "../../src/controller/rest.js"
    ],
    "names": [
        "assert",
        "require",
        "module",
        "exports",
        "think",
        "Controller",
        "_REST",
        "constructor",
        "ctx",
        "resource",
        "getResource",
        "id",
        "getId",
        "isFunction",
        "model",
        "modelInstance",
        "__before",
        "header",
        "userInfo",
        "session",
        "catch",
        "isAllowedMethod",
        "isMethod",
        "isAllowedResource",
        "isLogin",
        "isEmpty",
        "TokenExpiredError",
        "name",
        "indexOf",
        "throw",
        "controller",
        "split",
        "pop",
        "get",
        "isString",
        "isNumber",
        "last",
        "path",
        "slice",
        "getAction",
        "data",
        "pk",
        "where",
        "find",
        "success",
        "select",
        "postAction",
        "post",
        "fail",
        "insertId",
        "add",
        "deleteAction",
        "rows",
        "delete",
        "affectedRows",
        "putAction",
        "update",
        "__call"
    ],
    "mappings": "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",
    "file": "../../src/controller/rest.js",
    "sourcesContent": [
        "const assert = require(\"assert\");\n\nmodule.exports = class extends think.Controller {\n    static get _REST() {\n        return true;\n    }\n\n    constructor(ctx) {\n        super(ctx);\n        this.resource = this.getResource();\n        this.id = this.getId();\n        assert(think.isFunction(this.model), \"this.model must be a function\");\n        this.modelInstance = this.model(this.resource);\n    }\n    async __before() {\n        this.header(\"Access-Control-Allow-Origin\", \"*\");\n        // console.log('_before', 'fffff');\n        this.userInfo = await this.session(\"userInfo\").catch(() => {});\n        // console.log('userinfo', this.userInfo);\n        const isAllowedMethod = this.isMethod(\"GET\");\n        const isAllowedResource = this.resource === \"login\";\n        const isLogin = !(\n            think.isEmpty(this.userInfo) ||\n            typeof this.userInfo.TokenExpiredError !== \"undefined\" ||\n            (this.userInfo.name && this.userInfo.name.indexOf(\"Error\") != -1)\n        );\n\n        if (!isAllowedResource && !isLogin && !isAllowedMethod) {\n            return this.ctx.throw(401, \"请登录后操作\");\n        }\n    }\n    /**\n     * get resource\n     * @return {String} [resource name]\n     */\n    getResource() {\n        return this.ctx.controller.split(\"/\").pop();\n    }\n    getId() {\n        const id = this.get(\"id\");\n        if (id && (think.isString(id) || think.isNumber(id))) {\n            return id;\n        }\n        const last = this.ctx.path.split(\"/\").slice(-1)[0];\n        if (last !== this.resource) {\n            return last;\n        }\n        return \"\";\n    }\n    async getAction() {\n        let data;\n        if (this.id) {\n            const pk = this.modelInstance.pk;\n            data = await this.modelInstance.where({ [pk]: this.id }).find();\n            return this.success(data);\n        }\n        data = await this.modelInstance.select();\n        return this.success(data);\n    }\n    /**\n     * put resource\n     * @return {Promise} []\n     */\n    async postAction() {\n        const pk = this.modelInstance.pk;\n        const data = this.post();\n        delete data[pk];\n        if (think.isEmpty(data)) {\n            return this.fail(\"data is empty\");\n        }\n        const insertId = await this.modelInstance.add(data);\n        return this.success({ id: insertId });\n    }\n    /**\n     * delete resource\n     * @return {Promise} []\n     */\n    async deleteAction() {\n        if (!this.id) {\n            return this.fail(\"params error\");\n        }\n        const pk = this.modelInstance.pk;\n        const rows = await this.modelInstance.where({ [pk]: this.id }).delete();\n        return this.success({ affectedRows: rows });\n    }\n    /**\n     * update resource\n     * @return {Promise} []\n     */\n    async putAction() {\n        if (!this.id) {\n            return this.fail(\"params error\");\n        }\n        const pk = this.modelInstance.pk;\n        const data = this.post();\n        data[pk] = this.id; // rewrite data[pk] forbidden data[pk] !== this.id\n        if (think.isEmpty(data)) {\n            return this.fail(\"data is empty\");\n        }\n        const rows = await this.modelInstance\n            .where({ [pk]: this.id })\n            .update(data);\n        return this.success({ affectedRows: rows });\n    }\n    __call() {}\n};\n"
    ]
}